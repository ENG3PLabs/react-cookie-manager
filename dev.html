<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Cookie Manager Development</title>
    <link rel="stylesheet" href="dist/wordpress/cookie-manager.css" />

    <!-- Google Analytics initialization -->
    <script>
      window.ga =
        window.ga ||
        function () {
          (ga.q = ga.q || []).push(arguments);
        };
      ga.l = +new Date();
    </script>

    <!-- Test Analytics Script - Initially blocked -->
    <script
      type="text/plain"
      data-cookiekit="analytics"
      src="https://www.google-analytics.com/analytics.js"
    ></script>

    <!-- Analytics initialization code -->
    <script>
      function initializeAnalytics() {
        if (typeof ga !== "undefined") {
          ga("create", "UA-123456789-1", {
            cookieDomain: "none", // Prevent cookie domain issues in local testing
            cookieFlags: "SameSite=None; Secure", // Required for modern browsers
          });
          ga("set", "checkProtocolTask", null); // Disable protocol checking for local testing
          ga("set", "transport", "beacon"); // Use navigator.sendBeacon
          ga("send", "pageview");
          ga.loaded = true; // Mark as initialized
          console.log("‚úÖ Analytics initialized with test configuration");
        } else {
          console.error("‚ùå GA not available for initialization");
        }
      }
    </script>

    <!-- Test Marketing Script - Initially blocked -->
    <script
      type="text/plain"
      data-cookiekit="marketing"
      src="https://platform.twitter.com/widgets.js"
    ></script>

    <!-- Add consent check and network request testing -->
    <script>
      // Function to get current consent
      function getCurrentConsent() {
        const consent = document.cookie
          .split("; ")
          .find((row) => row.startsWith("cookie_consent="));

        if (consent) {
          try {
            const value = consent.split("=")[1];
            return JSON.parse(decodeURIComponent(value));
          } catch (e) {
            return null;
          }
        }
        return null;
      }

      // Function to check if URL should be blocked
      function shouldBlockRequest(url) {
        const urlString = url.toString();

        // Check if domain is in allowed domains - these are never blocked
        const allowedDomains = [
          "google-analytics.com",
          "analytics.google.com",
          "www.google-analytics.com",
        ];

        if (allowedDomains.some((domain) => urlString.includes(domain))) {
          console.log("‚úÖ Request allowed by allowlist:", urlString);
          return false;
        }

        const consent = getCurrentConsent();
        if (!consent) return true; // Block if no consent

        // Check analytics
        if (!consent.analytics && urlString.includes("google-analytics")) {
          console.log("üö´ Blocking analytics request:", urlString);
          return true;
        }

        // Check marketing
        if (
          !consent.marketing &&
          (urlString.includes("twitter") || urlString.includes("doubleclick"))
        ) {
          console.log("üö´ Blocking marketing request:", urlString);
          return true;
        }

        return false;
      }

      // Override fetch before anything else loads
      const originalFetch = window.fetch;
      window.fetch = function (url, options) {
        const urlString = url.toString();
        console.log("üîç Intercepted fetch request to:", urlString);

        if (shouldBlockRequest(urlString)) {
          console.log("üö´ Request blocked by consent settings");
          return Promise.resolve(
            new Response(null, {
              status: 403,
              statusText: "Blocked by consent settings",
            })
          );
        }

        return originalFetch.apply(this, arguments);
      };

      // Override XHR
      const originalXHROpen = XMLHttpRequest.prototype.open;
      XMLHttpRequest.prototype.open = function (method, url) {
        console.log("üîç Intercepted XHR request to:", url);

        if (shouldBlockRequest(url)) {
          console.log("üö´ Request blocked by consent settings");
          throw new Error("Request blocked by consent settings");
        }

        return originalXHROpen.apply(this, arguments);
      };
    </script>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          Oxygen, Ubuntu, Cantarell, "Open Sans", "Helvetica Neue", sans-serif;
        margin: 0;
        padding: 20px;
        line-height: 1.6;
      }
      .container {
        max-width: 800px;
        margin: 0 auto;
      }
      .debug-panel {
        margin-top: 20px;
        padding: 15px;
        background: #f5f5f5;
        border-radius: 8px;
      }
      .debug-panel button {
        margin: 5px;
        padding: 8px 16px;
        border: none;
        border-radius: 4px;
        background: #0070f3;
        color: white;
        cursor: pointer;
      }
      .debug-panel button:hover {
        background: #0051cc;
      }
      pre {
        background: #fff;
        padding: 10px;
        border-radius: 4px;
        overflow-x: auto;
      }
      .state-panel {
        margin-top: 20px;
        padding: 15px;
        background: #e0e0e0;
        border-radius: 8px;
      }
      .config-panel {
        margin-bottom: 20px;
        padding: 15px;
        background: #e8f0fe;
        border-radius: 8px;
      }
      .config-group {
        margin-bottom: 15px;
      }
      .config-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
      }
      select {
        padding: 8px;
        border-radius: 4px;
        border: 1px solid #ccc;
        background: white;
        min-width: 200px;
      }

      /* Add styles for analytics test */
      .test-analytics-btn {
        display: block;
        width: 100%;
        margin: 10px 0;
        padding: 8px 16px;
        background: #4f46e5;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 14px;
      }
      .test-analytics-btn:hover {
        background: #4338ca;
      }
      #analyticsResult {
        padding: 8px;
        background: white;
        border-radius: 4px;
        margin-top: 8px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>Cookie Manager Development</h1>

      <div class="config-panel">
        <h2>Configuration</h2>
        <div class="config-group">
          <label for="displayType">Display Type:</label>
          <select id="displayType" onchange="updateConfig()">
            <option value="banner">Banner</option>
            <option value="modal">Modal</option>
            <option value="popup">Popup</option>
          </select>
        </div>
        <div class="config-group">
          <label for="theme">Theme:</label>
          <select id="theme" onchange="updateConfig()">
            <option value="light">Light</option>
            <option value="dark">Dark</option>
          </select>
        </div>
      </div>

      <div class="debug-panel">
        <h2>Debug Panel</h2>
        <button onclick="window.CookieKit.showBanner()">Show Banner</button>
        <button onclick="window.CookieKit.showCustomizeModal()">
          Show Customize Modal
        </button>
        <button onclick="window.CookieKit.resetConsent()">Reset Consent</button>

        <!-- Add Test Analytics Button -->
        <div class="state-panel">
          <h3>Test Analytics:</h3>
          <button onclick="testAnalytics()" class="test-analytics-btn">
            Trigger Analytics Event
          </button>
          <div id="analyticsResult" class="mt-2 text-sm"></div>
        </div>

        <div class="state-panel">
          <h3>Current Cookie State:</h3>
          <pre id="cookieState">No consent set</pre>
        </div>
      </div>
    </div>

    <script src="dist/wordpress/cookie-manager.js"></script>
    <script>
      // Function to update the cookie state display
      function updateCookieState() {
        const consent = document.cookie
          .split("; ")
          .find((row) => row.startsWith("cookie_consent="));

        const stateDisplay = document.getElementById("cookieState");
        if (consent) {
          const value = consent.split("=")[1];
          try {
            const parsed = JSON.parse(decodeURIComponent(value));
            stateDisplay.textContent = JSON.stringify(parsed, null, 2);

            // Enable analytics script if consent is given
            if (parsed.analytics) {
              const analyticsScript = document.querySelector(
                'script[data-cookiekit="analytics"]'
              );
              if (
                analyticsScript &&
                analyticsScript.type !== "text/javascript"
              ) {
                analyticsScript.type = "text/javascript";
                // Wait for script to load then initialize
                analyticsScript.onload = function () {
                  console.log("Analytics script loaded, initializing...");
                  initializeAnalytics();
                };
                // Trigger script load by re-adding it to the document
                analyticsScript.parentNode.removeChild(analyticsScript);
                document.head.appendChild(analyticsScript);
              }
            }
          } catch (e) {
            stateDisplay.textContent = value;
          }
        } else {
          stateDisplay.textContent = "No consent set";
        }
      }

      // Add analytics test function
      function testAnalytics() {
        const result = document.getElementById("analyticsResult");
        console.log("üß™ Testing analytics event...");

        const consent = getCurrentConsent();
        console.log("Current consent state:", consent);

        // Direct network request to GA
        const params = {
          v: "1", // Version
          tid: "UA-123456789-1", // Tracking ID
          cid: "555", // Client ID (normally would be UUID)
          t: "event", // Hit type
          ec: "Test", // Event Category
          ea: "click", // Event Action
          el: "Direct Test " + new Date().toISOString(), // Event Label
          z: Math.floor(Math.random() * 10000000), // Cache buster
        };

        const url =
          "https://www.google-analytics.com/collect?" +
          Object.entries(params)
            .map(([key, value]) => `${key}=${encodeURIComponent(value)}`)
            .join("&");

        console.log("üöÄ Sending direct request to:", url);

        fetch(url, {
          method: "POST",
          mode: "no-cors", // Required for GA
        })
          .then((data) => {
            console.log("üöÄ Direct request sent successfully", data);
            result.innerHTML =
              "‚úÖ Direct analytics request sent. Check Network tab.";
            result.style.color = "#059669";
            console.log("‚úÖ Request sent successfully");
          })
          .catch((error) => {
            result.innerHTML = `‚ùå Error: ${error.message}`;
            result.style.color = "#dc2626";
            console.error("Request error:", error);
          });
      }

      // Function to get current configuration
      function getConfig() {
        return {
          style: document.getElementById("displayType").value,
          theme: document.getElementById("theme").value,
        };
      }

      // Function to initialize CookieKit with current config
      function initCookieKit() {
        const config = getConfig();
        console.log("üîÑ Reinitializing CookieKit with config:", config);

        window.CookieKit.init({
          ...config,
          allowedDomains: [
            "google-analytics.com",
            "analytics.google.com",
            "www.google-analytics.com",
          ],
          translations: {
            title: "Cookie Settings üç™",
            message:
              "We use cookies to improve your experience on our website. Choose which cookies you want to allow.",
            buttonText: "Accept All",
            declineButtonText: "Decline All",
            manageButtonText: "Manage Cookies",
            privacyPolicyText: "Privacy Policy",
            manageTitle: "Cookie Preferences",
            manageMessage: "Customize your cookie preferences below",
            manageEssentialTitle: "Essential Cookies",
            manageAnalyticsTitle: "Analytics",
            manageSocialTitle: "Social",
            manageAdvertTitle: "Advertising",
          },
          onAccept: () => {
            console.log("‚úÖ Cookies accepted");
          },
          onDecline: () => {
            console.log("‚ùå Cookies declined");
          },
          onManage: (categories) => {
            console.log("‚öôÔ∏è Cookie preferences updated:", categories);
          },
          showManageButton: true,
          privacyPolicyUrl: "https://example.com/privacy",
        });
      }

      // Function to update configuration
      function updateConfig() {
        console.log("üßπ Cleaning up existing elements");

        // Remove all cookie manager elements
        document
          .querySelectorAll(".cookie-manager")
          .forEach((el) => el.remove());

        // Remove any modals, overlays, or banners that might be outside cookie-manager
        document
          .querySelectorAll("[class*='cookie']")
          .forEach((el) => el.remove());

        // Clear the cookie to force a fresh state
        document.cookie =
          "cookie_consent=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;";

        console.log("‚ú® Initializing with new configuration");
        // Reinitialize with new config
        initCookieKit();

        // Use the existing instance to show the banner
        if (window.CookieKit.manager) {
          window.CookieKit.manager.createBanner();
          window.CookieKit.manager.createCustomizeModal();
        }
      }

      // Update state every second
      setInterval(updateCookieState, 1000);

      // Listen for consent updates
      window.addEventListener("cookiekit:consent-updated", (event) => {
        console.log("üç™ Consent updated:", event.detail);
        updateCookieState();
      });

      // Initial checks
      initCookieKit();
    </script>
  </body>
</html>
